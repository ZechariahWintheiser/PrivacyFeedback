<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy Customer Feedback System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0f9b8e, #2ecc71);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .privacy-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 0.95em;
            font-weight: 500;
        }

        .main-content {
            padding: 40px;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .feature-card {
            background: linear-gradient(135deg, #e8f8f5, #d5f4e6);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid #a9dfbf;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .feature-icon {
            font-size: 3em;
            margin-bottom: 20px;
            display: block;
        }

        .feature-card h3 {
            color: #0f9b8e;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .feature-card p {
            color: #555;
            line-height: 1.6;
        }

        .wallet-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .connect-button {
            background: linear-gradient(135deg, #16a085, #27ae60);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .connect-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .connect-button:disabled {
            background: #bdc3c7;
            transform: none;
            cursor: not-allowed;
            box-shadow: none;
        }

        .wallet-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .wallet-info h4 {
            color: #155724;
            margin-bottom: 10px;
        }

        .wallet-address {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            word-break: break-all;
        }

        .network-info {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .status-panel {
            background: linear-gradient(135deg, #d5f4e6, #abebc6);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #82e0aa;
        }

        .section-title {
            color: #0f9b8e;
            font-size: 1.8em;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .status-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .status-label {
            font-weight: 500;
            color: #495057;
        }

        .status-value {
            font-weight: 700;
            color: #0f9b8e;
            font-size: 1.1em;
        }

        .feedback-section {
            background: linear-gradient(135deg, #e8f8f5, #d5f4e6);
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            border: 1px solid #a9dfbf;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #0f9b8e;
            font-weight: 600;
            font-size: 1.05em;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #27ae60;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

        .rating-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .rating-stars {
            display: flex;
            gap: 5px;
        }

        .rating-star {
            font-size: 2em;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rating-star.active,
        .rating-star:hover {
            color: #ffd700;
            transform: scale(1.1);
        }

        .rating-display {
            font-weight: 600;
            color: #0f9b8e;
            margin-left: 10px;
        }

        .slider-container {
            margin-top: 10px;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .slider-value {
            text-align: center;
            font-weight: 600;
            color: #0f9b8e;
            margin-top: 10px;
        }

        .submit-button {
            background: linear-gradient(135deg, #16a085, #27ae60);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 25px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
            font-weight: 600;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3);
        }

        .submit-button:disabled {
            background: #bdc3c7;
            transform: none;
            cursor: not-allowed;
            box-shadow: none;
        }

        .privacy-info {
            background: linear-gradient(135deg, #d5f4e6, #abebc6);
            border: 1px solid #82e0aa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
        }

        .privacy-info h4 {
            color: #0f9b8e;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .privacy-info p {
            color: #145a32;
            line-height: 1.6;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #27ae60;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .disabled-section {
            opacity: 0.5;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .main-content {
                padding: 20px;
            }

            .features-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .status-grid {
                grid-template-columns: 1fr;
            }

            .rating-container {
                flex-direction: column;
                align-items: flex-start;
            }

            .feature-card,
            .feedback-section,
            .status-panel,
            .wallet-section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔒 Privacy Customer Feedback</h1>
            <p>Confidential Analysis with FHE Technology</p>
            <div class="privacy-badge">
                🛡️ Fully Homomorphic Encryption Protected
            </div>
        </div>

        <div class="main-content">
            <!-- Wallet Connection -->
            <div class="wallet-section">
                <h2 class="section-title">🔗 Connect Wallet</h2>
                <button class="connect-button" onclick="connectWallet()" id="connectButton">
                    Connect MetaMask Wallet
                </button>
                <div id="walletInfo" class="wallet-info">
                    <h4>✅ Connected to Sepolia Testnet</h4>
                    <div class="wallet-address" id="walletAddress"></div>
                    <div class="network-info" id="networkInfo">
                        Network: Sepolia (Chain ID: 11155111)
                    </div>
                </div>
            </div>

            <!-- System Features -->
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">🔐</div>
                    <h3>Fully Homomorphic Encryption</h3>
                    <p>All feedback data is encrypted end-to-end using Zama FHE technology, ensuring complete privacy and security on Sepolia testnet.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">📊</div>
                    <h3>Confidential Analysis</h3>
                    <p>Perform analytics on encrypted data without decryption, maintaining privacy while extracting valuable insights from customer feedback.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🛡️</div>
                    <h3>Privacy Protection</h3>
                    <p>Advanced privacy protection mechanisms ensure individual feedback data is never compromised or exposed to unauthorized parties.</p>
                </div>
            </div>

            <!-- System Status -->
            <div class="status-panel" id="statusPanel">
                <h2 class="section-title">📈 System Status</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <span class="status-label">Total Feedbacks:</span>
                        <span class="status-value" id="totalFeedbacks">Connect wallet</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Analysis Status:</span>
                        <span class="status-value" id="analysisStatus">Connect wallet</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Your Feedbacks:</span>
                        <span class="status-value" id="userFeedbacks">Connect wallet</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Contract Address:</span>
                        <span class="status-value" id="contractAddress">0x6829...8fa6</span>
                    </div>
                </div>
            </div>

            <!-- Feedback Submission -->
            <div class="feedback-section disabled-section" id="feedbackSection">
                <h2 class="section-title">📝 Submit Encrypted Feedback</h2>

                <div class="form-group">
                    <label>Satisfaction Rating (1-5 stars):</label>
                    <div class="rating-container">
                        <div class="rating-stars">
                            <span class="rating-star" data-rating="1">⭐</span>
                            <span class="rating-star" data-rating="2">⭐</span>
                            <span class="rating-star" data-rating="3">⭐</span>
                            <span class="rating-star" data-rating="4">⭐</span>
                            <span class="rating-star" data-rating="5">⭐</span>
                        </div>
                        <div class="rating-display" id="ratingDisplay">Please select rating</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="category">Feedback Category:</label>
                    <select id="category">
                        <option value="">Select Category</option>
                        <option value="1">Product Quality</option>
                        <option value="2">Customer Service</option>
                        <option value="3">Delivery Speed</option>
                        <option value="4">Pricing</option>
                        <option value="5">User Experience</option>
                        <option value="6">Technical Support</option>
                        <option value="7">Website Features</option>
                        <option value="8">Return Policy</option>
                        <option value="9">Product Variety</option>
                        <option value="10">Others</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="sentiment">Sentiment Score (1-10):</label>
                    <div class="slider-container">
                        <input type="range" id="sentiment" min="1" max="10" value="5">
                        <div class="slider-labels">
                            <span>1 (Very Dissatisfied)</span>
                            <span>10 (Very Satisfied)</span>
                        </div>
                        <div class="slider-value" id="sentimentValue">5</div>
                    </div>
                </div>

                <button class="submit-button" onclick="submitFeedback()" id="submitButton">
                    🔒 Submit Encrypted Feedback
                </button>

                <div id="successMessage" class="success-message">
                    ✅ Feedback submitted successfully! Your data is encrypted and stored on the blockchain.
                </div>

                <div id="errorMessage" class="error-message">
                    ❌ Submission failed. Please try again.
                </div>

                <div class="privacy-info">
                    <h4>🔐 Privacy Protection Notice</h4>
                    <p>Your feedback will be encrypted using Zama FHE (Fully Homomorphic Encryption) technology. All data remains encrypted on the Sepolia testnet, and only authorized analysis functions can process the data without decryption. Your personal information and specific feedback content will remain completely confidential.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        // Ensure ethers is loaded properly with fallback
        function loadEthersWithFallback() {
            if (typeof ethers !== 'undefined') {
                console.log('Ethers.js loaded successfully:', ethers.version);
                return Promise.resolve();
            }

            console.warn('Primary CDN failed, trying fallback...');
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
                script.onload = () => {
                    if (typeof ethers !== 'undefined') {
                        console.log('Ethers.js loaded from fallback CDN:', ethers.version);
                        resolve();
                    } else {
                        reject(new Error('Ethers failed to load from fallback CDN'));
                    }
                };
                script.onerror = () => reject(new Error('Failed to load ethers from fallback CDN'));
                document.head.appendChild(script);
            });
        }

        // Initialize ethers with error handling
        loadEthersWithFallback().catch(error => {
            console.error('Critical error: Ethers.js failed to load:', error);
            alert('Failed to load required blockchain libraries. Please check your internet connection and refresh the page.');

            // Disable wallet functionality
            document.getElementById('connectButton').disabled = true;
            document.getElementById('connectButton').textContent = 'Libraries failed to load';
        });

        // Contract Configuration
        const CONTRACT_ADDRESS = "0x6829060333a916C9839B9DB70374357419b68fa6";
        const SEPOLIA_CHAIN_ID = "0xaa36a7"; // 11155111 in hex
        const SEPOLIA_NETWORK = {
            chainId: SEPOLIA_CHAIN_ID,
            chainName: "Sepolia Test Network",
            nativeCurrency: {
                name: "Sepolia ETH",
                symbol: "SEP",
                decimals: 18
            },
            rpcUrls: ["https://sepolia.infura.io/v3/"],
            blockExplorerUrls: ["https://sepolia.etherscan.io/"]
        };

        let provider, signer, contract, userAccount;
        let selectedRating = 0;

        // Privacy Feedback Contract ABI
        const CONTRACT_ABI = [
            {
                "inputs": [
                    {"type": "uint8", "name": "_satisfaction"},
                    {"type": "uint8", "name": "_category"},
                    {"type": "uint8", "name": "_sentimentScore"}
                ],
                "name": "submitFeedback",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getPublicStats",
                "outputs": [
                    {"type": "uint32", "name": "totalFeedbacks"},
                    {"type": "bool", "name": "analysisAvailable"},
                    {"type": "uint256", "name": "contractDeployTime"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"type": "address", "name": "user"}],
                "name": "getUserFeedbackCount",
                "outputs": [{"type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "feedbackCounter",
                "outputs": [{"type": "uint32"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupRatingSystem();
            setupSentimentSlider();
            updateContractAddressDisplay();
        });

        // Setup rating system
        function setupRatingSystem() {
            const stars = document.querySelectorAll('.rating-star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    selectedRating = parseInt(this.dataset.rating);
                    updateStars();
                });

                star.addEventListener('mouseover', function() {
                    const rating = parseInt(this.dataset.rating);
                    highlightStars(rating);
                });
            });

            document.querySelector('.rating-stars').addEventListener('mouseleave', function() {
                updateStars();
            });
        }

        function highlightStars(rating) {
            const stars = document.querySelectorAll('.rating-star');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function updateStars() {
            const stars = document.querySelectorAll('.rating-star');
            const ratingDisplay = document.getElementById('ratingDisplay');

            stars.forEach((star, index) => {
                if (index < selectedRating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });

            ratingDisplay.textContent = selectedRating > 0 ? `${selectedRating}/5 stars` : 'Please select rating';
        }

        // Setup sentiment slider
        function setupSentimentSlider() {
            const sentimentSlider = document.getElementById('sentiment');
            const sentimentValue = document.getElementById('sentimentValue');

            sentimentSlider.addEventListener('input', function() {
                sentimentValue.textContent = this.value;
            });
        }

        // Connect wallet with Sepolia network handling
        async function connectWallet() {
            const connectButton = document.getElementById('connectButton');

            // 1. Check if MetaMask is installed
            if (typeof window.ethereum === 'undefined') {
                showError('Please install MetaMask wallet to continue');
                return;
            }

            try {
                connectButton.disabled = true;
                connectButton.innerHTML = '<span class="loading-spinner"></span>Detecting MetaMask...';

                // 2. Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });

                connectButton.innerHTML = '<span class="loading-spinner"></span>Connecting to Sepolia...';

                // 3. Check current network
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });

                // 4. Switch/Add Sepolia network if needed
                if (chainId !== SEPOLIA_CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: SEPOLIA_CHAIN_ID }],
                        });
                    } catch (switchError) {
                        // Network not added, try to add it
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [SEPOLIA_NETWORK],
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }

                connectButton.innerHTML = '<span class="loading-spinner"></span>Setting up provider...';

                // 5. Setup provider and signer
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAccount = await signer.getAddress();

                // 6. Initialize contract
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // 7. Update UI state
                document.getElementById('walletAddress').textContent = userAccount;
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('feedbackSection').classList.remove('disabled-section');

                connectButton.textContent = '✅ Connected to Sepolia!';
                connectButton.style.background = '#27ae60';

                // 8. Load initial state
                showSuccess('Successfully connected to Sepolia testnet! ✅');
                await loadSystemStatus();

                // Listen for network/account changes
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);

            } catch (error) {
                console.error('Wallet connection failed:', error);
                let errorMessage = 'Wallet connection failed. Please try again.';

                if (error.code === 4001) {
                    errorMessage = 'Connection rejected by user';
                } else if (error.code === -32002) {
                    errorMessage = 'Connection request already pending';
                } else if (error.message && error.message.includes('network')) {
                    errorMessage = 'Failed to connect to Sepolia network';
                }

                showError(errorMessage);
                resetWalletUI();
            }
        }

        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                resetWalletUI();
                showError('Wallet disconnected');
            } else {
                location.reload(); // Reload to reinitialize with new account
            }
        }

        function handleChainChanged(chainId) {
            if (chainId !== SEPOLIA_CHAIN_ID) {
                resetWalletUI();
                showError('Please switch back to Sepolia network');
            } else {
                location.reload(); // Reload to reinitialize
            }
        }

        function resetWalletUI() {
            provider = null;
            signer = null;
            contract = null;
            userAccount = null;

            document.getElementById('walletInfo').style.display = 'none';
            document.getElementById('feedbackSection').classList.add('disabled-section');
            document.getElementById('connectButton').textContent = 'Connect MetaMask Wallet';
            document.getElementById('connectButton').style.background = 'linear-gradient(135deg, #16a085, #27ae60)';
            document.getElementById('connectButton').disabled = false;

            // Reset status display
            document.getElementById('totalFeedbacks').textContent = 'Connect wallet';
            document.getElementById('analysisStatus').textContent = 'Connect wallet';
            document.getElementById('userFeedbacks').textContent = 'Connect wallet';
        }

        // Load system status from contract
        async function loadSystemStatus() {
            try {
                if (!contract) return;

                // Get public stats
                const stats = await contract.getPublicStats();
                document.getElementById('totalFeedbacks').textContent = stats.totalFeedbacks.toString();
                document.getElementById('analysisStatus').textContent = stats.analysisAvailable ? '✅ Available' : '⏳ Processing';

                // Get user feedback count
                if (userAccount) {
                    const userFeedbackCount = await contract.getUserFeedbackCount(userAccount);
                    document.getElementById('userFeedbacks').textContent = userFeedbackCount.toString();
                }

            } catch (error) {
                console.error('Failed to load system status:', error);
                document.getElementById('totalFeedbacks').textContent = 'Error loading';
                document.getElementById('analysisStatus').textContent = 'Error loading';
                document.getElementById('userFeedbacks').textContent = 'Error loading';
            }
        }

        // Submit feedback to contract
        async function submitFeedback() {
            if (!userAccount) {
                showError('Please connect your wallet first');
                return;
            }

            if (selectedRating === 0) {
                showError('Please select a satisfaction rating');
                return;
            }

            const category = document.getElementById('category').value;
            if (!category) {
                showError('Please select a feedback category');
                return;
            }

            const sentiment = document.getElementById('sentiment').value;
            const submitButton = document.getElementById('submitButton');

            try {
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="loading-spinner"></span>Encrypting feedback...';

                hideMessages();

                // Estimate gas for transaction
                const gasEstimate = await contract.estimateGas.submitFeedback(
                    selectedRating,
                    parseInt(category),
                    parseInt(sentiment)
                );

                submitButton.innerHTML = '<span class="loading-spinner"></span>Submitting to blockchain...';

                // Submit transaction with gas buffer
                const transaction = await contract.submitFeedback(
                    selectedRating,
                    parseInt(category),
                    parseInt(sentiment),
                    {
                        gasLimit: gasEstimate.mul(120).div(100) // 20% buffer
                    }
                );

                submitButton.innerHTML = '<span class="loading-spinner"></span>Waiting for confirmation...';

                // Wait for transaction confirmation
                const receipt = await transaction.wait();

                showSuccess(`Feedback submitted successfully! Transaction: ${receipt.transactionHash.substring(0, 10)}...`);

                // Reset form
                resetForm();

                // Update system status
                await loadSystemStatus();

            } catch (error) {
                console.error('Submission failed:', error);
                let errorMessage = 'Submission failed. Please try again.';

                if (error.code === 4001) {
                    errorMessage = 'Transaction rejected by user';
                } else if (error.code === -32603) {
                    errorMessage = 'Network error. Please check your connection.';
                } else if (error.message && error.message.includes('insufficient funds')) {
                    errorMessage = 'Insufficient ETH for gas fees';
                } else if (error.message && error.message.includes('gas')) {
                    errorMessage = 'Gas estimation failed. Try adjusting gas settings.';
                }

                showError(errorMessage);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = '🔒 Submit Encrypted Feedback';
            }
        }

        function resetForm() {
            selectedRating = 0;
            updateStars();
            document.getElementById('category').value = '';
            document.getElementById('sentiment').value = 5;
            document.getElementById('sentimentValue').textContent = '5';
        }

        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            successElement.textContent = '✅ ' + message;
            successElement.style.display = 'block';
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 8000);
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = '❌ ' + message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 8000);
        }

        function hideMessages() {
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function updateContractAddressDisplay() {
            const addressElement = document.getElementById('contractAddress');
            addressElement.textContent = CONTRACT_ADDRESS.substring(0, 6) + '...' + CONTRACT_ADDRESS.substring(38);
        }

        // Auto-refresh status every 30 seconds if connected
        setInterval(async () => {
            if (contract && userAccount) {
                await loadSystemStatus();
            }
        }, 30000);
    </script>
</body>
</html>